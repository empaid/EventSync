<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="opfs.js"></script>
    <script>

    let live = false;
    let event;  
    let offset = 0;
    let logList = document.getElementById("logs")

     function logToList(...args) {
    const li = document.createElement("li");
    li.textContent = args.map(a =>
      (Array.isArray(a) || typeof a === "object") ? JSON.stringify(a) : String(a)
    ).join(" ");
    logList.appendChild(li);


    if (logList.children.length > 100) {
      logList.removeChild(logList.firstChild);
    }
    
    logList.scrollTop = logList.scrollHeight;
  }

    const offsets = [];
    function updateOffset(sample){
        offsets.push(sample)
        if(offsets.length > 6 ) offsets.shift();
        offset = Math.round(offsets.reduce((a,b)=> a+b, 0) / offsets.length);
        console.log("Offset: ",offset, offsets)
         logToList("Offset:", offset, offsets);
    }
    

    

    window.onload = function () {
    
    logList = document.getElementById("logs")
    const socket = io("ws://localhost:8000/event");
    
    const params = new URLSearchParams(window.location.search);
    const eventId = params.get('event_id');

    socket.emit("join_event", { event_id: eventId});
      


    audio_controller = document.getElementById('main');
    function pingServerForTime(){
        const t0 = Date.now();
        socket.emit("fetch_server_time", t0)
    }
    socket.on("connect", () => {
        console.log("Connected to Socket.dfdfdIO!")
        pingServerForTime();
    });

    socket.on("joined", async (data) => {
      event = data.event;
      console.log(event)
      document.getElementById('event-name').innerHTML = event.title;
      const assets = (event.assets || []).filter(a => a.active == true);
      if (!assets.length) return;
      await cacheEventAssetsOPFS(assets);
      
      if(!event.live){
        document.getElementById('content').innerHTML = 
        `
            Please wait. Event is not live.
        `;
      }

    });

    socket.on("server_time", (data) => {
        const t2 = Date.now();
        const server_time = data.server_now_ms
        const t0 = data.client_echo_ms
        const response_time = t2 - t0;
        const one_way_time = response_time/2;
        const current_time_at_server = server_time + one_way_time
        const currOffset = current_time_at_server - t2;
        updateOffset(currOffset)
        setTimeout(pingServerForTime, 3000);
    })

    
    socket.on("sync", (data) => {
        const target_client_ms = data.target_server_ms - offset;
        const t0 = Date.now()
        const delay = target_client_ms - t0;
        console.log("Delay:", delay)
        logToList("Delay:", delay);
        if(delay < 0){
            delay = 10;
            console.log('here')
        }
        setTimeout(()=> {
        
        if(data.play_state == 'play'){
            
            audio_controller.play()
        }

         if(data.play_state == 'pause'){
            
            audio_controller.pause()
        }
        audio_controller.currentTime = data.current_seconds
    }, delay);

        
        
        console.log("recv:", data)});
    }
    </script>

</head>
<body>
    <h1 id="event-name"></h1>
    <!-- <audio id="audio" controls></audio> -->
    <div id="content">

    </div>
    
    <ul id="logs">
    </ul>
</body>
</html>